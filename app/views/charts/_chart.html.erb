<script>

    addTagButton = function(tag){
        var tagButton=$('<button>' + tag + '</button>') // Create the element
                .button({icons: {secondary: "ui-icon-closethick"}}) // Ask jQuery UI to buttonize it
                .click(function(){ removeTag( $("#series-key").text(), tag, this ); }); // Add a click handler

        $('#series-metadata')
                .append(tagButton);
    };

    addAttributeButton = function(key, value){
        var attrButton=$('<button>' + key + ':' + value + '</button>') // Create the element
                .button({icons: {secondary: "ui-icon-closethick"}}) // Ask jQuery UI to buttonize it
                .click(function(){ removeAttribute( $("#series-key").text(), key, this ); }); // Add a click handler

        $('#series-metadata')
                .append(attrButton);
    }

    removeTag = function(series_key, tag, sender) {
        $('<div></div>').appendTo('body')
            .html('<div><h6>Are you sure?</h6></div>')
            .dialog({
                modal: true,
                resizable: false,
                title: 'Remove Tag',
                width: 'auto',
                buttons: {
                    "Delete": function () {
                        $.ajax({
                            url: "/datasets/remove_tag?series_key=" + series_key + "&tag=" + tag,
                            success: function(data) {
                                sender.remove();
                                }
                        });

                        $(this).dialog("close");
                    },
                    Cancel: function () {
                        $(this).dialog("close");
                    }
                },
                close: function (event, ui) {
                    $(this).remove();
                }
            });
    };

    removeAttribute = function(series_key, attribute, sender) {
        $('<div></div>').appendTo('body')
                .html('<div><h6>Are you sure?</h6></div>')
                .dialog({
                    modal: true,
                    resizable: false,
                    title: 'Remove Attribute',
                    width: 300,
                    buttons: {
                        "Delete": function () {
                            $.ajax({
                                url: "/datasets/remove_attribute?series_key=" + series_key + "&attribute=" + attribute,
                                success: function(data) {
                                    sender.remove();
                                }
                            });

                            $(this).dialog("close");
                        },
                        Cancel: function () {
                            $(this).dialog("close");
                        }
                    },
                    close: function (event, ui) {
                        $(this).remove();
                    }
                });
    };

    checkLength = function ( o ) {
        if ( o.val().length == 0  ) {
            o.addClass( "ui-state-error" );
            return false;
        } else {
            return true;
        }
    };

    $(function() {
        var series_key = $( "#series-key" ),
            dialog_tag = $( "#dialog-tag" ),
            dialog_key = $( "#dialog-key" ),
            dialog_value = $( "#dialog-value" ),
            allFields = $( [] ).add( dialog_tag ).add( dialog_key ).add( dialog_value );

        $( "#dialog-form" ).dialog({
            autoOpen: false,
            height: 400,
            width: 500,
            modal: true,
            buttons: {
                Cancel: function() {
                    $( this ).dialog( "close" );
                },
                "Add": function() {
                    allFields.removeClass( "ui-state-error" );

                    if ( checkLength(dialog_tag)) {
                        var tag = dialog_tag.val();
                        $.ajax({
                            url: "/datasets/add_tag?series_key=" + series_key.text() + "&tag=" + tag,
                            success: function(data) {
                                addTagButton(tag);
                            }
                        });

                        $( this ).dialog( "close" );
                    }
                    else if (checkLength(dialog_key) && checkLength(dialog_value)) {
                        var attribute = dialog_key.val(),
                            value = dialog_value.val()
                        $.ajax({
                            url: "/datasets/update_attribute?series_key=" + series_key.text() + "&attribute=" + attribute + "&value=" + value,
                            success: function(data) {
                                addAttributeButton(attribute,value);
                            }
                        });

                        $( this ).dialog( "close" );
                    }
                }
            },
            close: function() {
                allFields.val( "" ).removeClass( "ui-state-error" );
            }
        });

        $( "#addMetadata" )
                .button({icons: {primary: "ui-icon-plusthick"}, text: false}) // Ask jQuery UI to buttonize it
                .click(function() {
                    $( "#dialog-form" ).dialog( "open" );
                });
        });
</script>

<h2 class="ui header"><%= chart.name %></h2>
<%= link_to "Save this chart", [:charts, series: chart.series], method: :post, remote: true, class: 'ui submit button' %>

<div class="ui segment">
  <div id="<%= chart.name.parameterize %>" class="chart with-3d-shadow with-transitions"
    data-source-url="<%= multiple_datasets_path(chart.series) %>">
    <svg style="height: 500px;"></svg>
  </div>
</div>

<hidden id="series-key"></hidden>

<div class="ui one column row">
  <div class="column">
    <div id="series-metadata">
      <h3>Series Tags and Attributes</h3>
      <button id="addMetadata">New</button>
    </div>
  </div>
</div>

<div id="dialog-form" title="Add a tag or attribute">
  <div class="form-row">
    <label>Tag</label>
    <div class="metadata-info">Ex: <span class="info">humidity</span></div>
    <div class="metadata-error error" style="display: none;">The tag is invalid.</div>
    <input class="add-tag" type="text" id="dialog-tag" maxlength="255">
  </div>
  <h3 class="or">or</h3>
  <div class="form-row">
    <label>Attribute</label>
    <div class="metadata-info">Ex: <span class="info">thermostat: 1</span></div>
    <div class="metadata-error error" style="display: none;">The attribute is invalid.</div>
    <br>
    <input class="add-attribute add-attribute-key" type="text" id="dialog-key" maxlength="255">
    <span class="colon"> : </span>
    <input class="add-attribute add-attribute-value" type="text" id="dialog-value" maxlength="255">
  </div>
</div>
